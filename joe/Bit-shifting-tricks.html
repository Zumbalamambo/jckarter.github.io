<!DOCTYPE html>
<html>
<head>
<title>Bit-shifting tricks</title>
<link rel="stylesheet" href="../durians.css">
<link rel="alternate" type="application/rss+xml" title="Durian Software: Joe's Blog" href="index.rss">
<script src="../durians.js"></script>
</head>
<body class="blog">
<div class="subtitle"><a href="index.html">Joe's blog</a></div>
<a href="../index.html"><img class="marquee" src="../durians.png"></a>
<div class="content">

<div class="sidebar">
<h4>About Me</h4>
<p>My name's Joe Groff. I'm a programmer in Portland, Oregon, USA.<br>
<br><script>male_to('com', 'joe', 'duriansoftware')</script>
<br>twitter <a href="http://twitter.com/jckarter">@jckarter</a>
<br>github <a href="http://github.com/jckarter">jckarter</a>
</p>
<h4>My Friends</h4>
<p>
<a href="http://bugsplat.info/">Peter Keen</a><br>
<a href="http://leto.net/">Jonathan Leto</a><br>
<a href="http://factor-language.blogspot.com/">Slava Pestov</a><br>
<a href="http://www.kssreeram.org/">KS Sreeram</a><br>
<a href="http://profile.myspace.com/index.cfm?fuseaction=user.viewprofile&friendid=189198983">The Summer Darlings</a>
</p>
</div>

<div class="blog">
<h3><a href="http://duriansoftware.com/joe/Bit-shifting-tricks.html">Bit-shifting tricks</a></h3>
<h4>updated January 8, 2009 13:16:00 PDT</h4>
<p>The Principia Mathematica of bit-twiddling hack lists is <a href="http://graphics.stanford.edu/~seander/bithacks.html">Sean Eron Anderson's page</a>. Here are some I found myself needing recently.</p>
<h4>Least power of two greater than x (LPOT)</h4>
<p>OpenGL ES takes you back to the days when troll dolls were popular and non-power-of-two textures weren't a standard video card feature, so when you load your odd-sized sprites and HUD images into textures, you need to round your image dimensions up to powers of two. Sorta like how you used to have to roll up your car windows yourself. You can do it in a quick burst of right shift-OR combos:</p>
<pre>
unsigned lpot(unsigned x)
    { --x; x |= x&gt;&gt;1; x|=x&gt;&gt;2; x|=x&gt;&gt;4; x|=x&gt;&gt;8; x|=x&gt;&gt;16; return ++x; }
</pre>
<p>The initial decrement handles the corner case when <tt>x</tt> is already a power of two. The shifts fill the top bit down into the rest of the int, and the final increment bumps the result up to a power of two. On ARM this makes great use of the barrel shifter:</p>
<pre>
_lpot:
	sub	r0, r0, #1
	orr	r0, r0, r0, lsr #1
	orr	r0, r0, r0, lsr #2
	orr	r0, r0, r0, lsr #4
	orr	r0, r0, r0, lsr #8
	orr	r0, r0, r0, lsr #16
	add	r0, r0, #1
	bx	lr
</pre>
<p>If you happen to have your image dimensions in a float ('cause that's how they roll down in Cupertino), getting the LPOT is even easier. We just bump up the exponent and clear the mantissa.</p>
<pre>
float lpot_float(float x)
{
    union { float f; int bits; } xx = { x };
    xx.bits += (1 &lt;&lt; 23) - 1; // minus 1 to handle when x is already a POT
    xx.bits &amp;= 0xFF800000;
    return xx.f;
}
</pre>
<p>A little tip: When reaching up a float's skirt to mess with its bits, use a union rather than pointer casting. While those casts look manly, GCC isn't smart enough to see what you're trying to do and will waste 4 bytes of stack space to do a store/load to. This C code:</p>
<pre>
float lpot_float_ptrcast(float x)
{
    int bits = *(int*)&amp;x;
    bits += (1 &lt;&lt; 23) - 1;
    bits &amp;= 0xFF800000;
    return *(float*)&amp;bits;
}
</pre>
<p>compiles to this with <tt>-O3</tt>:</p>
<pre>
_lpot_float_ptrcast:
    sub     sp, sp, #8
    str     r0, [sp, #0]
    ldr     r3, [sp, #0]
    ldr     r2, L13
    sub     r3, r3, #-67108863
    sub     r3, r3, #58720256
    and     r3, r3, r2
    str     r3, [sp, #4]
    ldr     r0, [sp, #4]
    add     sp, sp, #8
    bx      lr
L13:
    .long	-8388608
</pre>
<p>Whereas with the union, the compiler will recognize and optimize away the union assignment:</p>
<pre>
_lpot_float:
    ldr	r3, L8
    sub	r0, r0, #-67108863
    sub	r0, r0, #58720256
    and	r0, r0, r3
    bx	lr
L8:
    .long	-8388608
</pre>



</div>

<div class="cleared"></div>
<br><script>male_to('com', 'joe', 'duriansoftware', 'Email me')</script>
<br><a class="archives" href="archives.html">Archives</a>

<div style="clear:both"></div>
</div>

<div class="fineprint">
&copy; 2012 Durian Software. | <a href="../contact.html">Contact Us</a>
</div>
</body>
</html>
